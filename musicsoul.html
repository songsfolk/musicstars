<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>El Alma del Jazz</title>
<!-- Iconos FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
    /* =========================================
       ESTILOS ORIGINALES (FACHADA P√öBLICA)
       ========================================= */
    body {
        font-family: 'Georgia', serif;
        background-color: #1e1e1e;
        color: #f0e6d2;
        margin: 0;
        padding: 20px;
        line-height: 1.6;
    }

    h1 { text-align: center; color: #d4af37; font-size: 2.5em; margin-bottom: 20px; }
    h2 { color: #d4af37; font-size: 1.8em; margin-top: 30px; }
    
    .container {
        max-width: 900px; margin: 0 auto;
        background-color: #2b2b2b; padding: 30px;
        border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    p { font-size: 1.1em; margin: 15px 0; }
    .figure { display: flex; align-items: center; margin: 20px 0; }
    .figure img { width: 150px; height: 150px; object-fit: cover; border-radius: 50%; margin-right: 20px; border: 2px solid #d4af37; }
    .figure-text { flex: 1; }
    
    ul { list-style-type: none; padding: 0; }
    li { margin: 10px 0; font-style: italic; }
    a.song-link { color: #87ceeb; text-decoration: none; }
    a.song-link:hover { color: #b0e0e6; text-decoration: underline; }

    /* EL SECRETO: Camuflaje perfecto */
    a.secret-link { 
        color: inherit; text-decoration: none; cursor: text; 
    }
    a.secret-link:hover { color: inherit; text-decoration: none; }

    /* Comentarios Fake Est√°ticos */
    .fake-comment { border-bottom: 1px solid #444; padding: 15px 0; }
    .fake-meta { font-size: 0.8em; color: #888; margin-bottom: 5px; }
    .fake-user { color: #d4af37; font-weight: bold; }
    .nuevo-comentario { animation: highlight 2s; }
    @keyframes highlight { from { background: #333; } to { background: transparent; } }

    /* Inputs P√∫blicos */
    .input-container-public { display: flex; margin-top: 20px; gap: 10px; }
    #mensajeInputPublico { flex: 1; background: #f0e6d2; border: none; padding: 10px; border-radius: 5px; font-family: 'Georgia', serif; }
    #enviarMensajePublico { background: #d4af37; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }

    @media (max-width: 600px) {
        h1 { font-size: 2em; }
        .figure { flex-direction: column; text-align: center; }
        .figure img { margin: 0 0 10px 0; width: 120px; height: 120px; }
    }

    /* =========================================
       NUEVOS ESTILOS (SECCI√ìN ROM√ÅNTICA 3D EXTREMO)
       ========================================= */
    :root {
        --bg-deep: #050508;
        --card-bg: #14141a;
        --accent: #9b59b6; /* Violeta Intenso */
        --gold: #d4af37;
        /* Sombra 3D Intensa */
        --shadow-3d: 0 15px 30px rgba(0,0,0,0.7), 0 5px 15px rgba(0,0,0,0.5);
        --shadow-inset: inset 3px 3px 7px rgba(0,0,0,0.8), inset -2px -2px 5px rgba(255,255,255,0.05);
        --glass: rgba(255, 255, 255, 0.03);
    }

    #seccion-secreta {
        display: none; /* Se activa con JS */
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: radial-gradient(circle at center, #1a1a24 0%, #050508 100%);
        z-index: 9999; overflow-y: auto;
        font-family: 'Segoe UI', sans-serif;
    }

    /* Login 3D */
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; perspective: 1500px; }
    .login-box {
        background: var(--card-bg); padding: 40px; border-radius: 20px;
        width: 90%; max-width: 380px; text-align: center;
        box-shadow: var(--shadow-3d); border: 1px solid rgba(255,255,255,0.05);
        transform: rotateX(5deg) rotateY(-2deg); /* Rotaci√≥n 3D visible */
        transition: transform 0.3s;
    }
    .login-box:hover { transform: rotateX(0) rotateY(0) scale(1.02); } /* Efecto al pasar rat√≥n */
    
    .input-3d {
        width: 100%; padding: 15px; margin: 10px 0; background: #0a0a0e;
        border: none; border-radius: 12px; color: #fff; box-shadow: var(--shadow-inset);
        box-sizing: border-box; font-size: 16px;
    }
    .input-3d:focus { outline: none; box-shadow: 0 0 0 2px var(--accent); }

    .btn-3d {
        background: linear-gradient(145deg, #8e44ad, #5e3370); color: white; border: none;
        padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer;
        width: 100%; margin-top: 15px; 
        box-shadow: 0 8px 15px rgba(142, 68, 173, 0.4), 0 4px 4px rgba(0,0,0,0.5); /* Sombra elevada */
        transition: transform 0.1s, box-shadow 0.1s;
        transform: translateY(-2px);
    }
    .btn-3d:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    .btn-secondary { background: #333; width: auto; font-size: 0.8em; box-shadow: none; margin: 0; transform: none; }

    /* App Layout */
    .app-layout { max-width: 850px; margin: 0 auto; padding: 20px; color: #ddd; perspective: 1000px; }
    .header-bar {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;
    }

    .card-3d {
        background: var(--card-bg); border-radius: 15px; padding: 25px; margin-bottom: 25px;
        box-shadow: var(--shadow-3d); border: 1px solid rgba(255,255,255,0.05);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: translateZ(0);
    }
    .card-3d:hover { transform: translateY(-8px) scale(1.01); } /* Flotaci√≥n intensa */

    /* Chat 3D */
    .chat-header-actions {
        display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;
    }

    .chat-window {
        background: #09090c; height: 450px; border-radius: 12px; padding: 20px;
        overflow-y: auto; box-shadow: var(--shadow-inset);
        display: flex; flex-direction: column; gap: 15px;
        background-image: radial-gradient(#2a2a35 1px, transparent 1px); background-size: 20px 20px;
    }
    
    .msg-bubble {
        max-width: 80%; padding: 12px 18px; border-radius: 18px; font-size: 0.95em;
        position: relative; word-wrap: break-word; 
        box-shadow: 5px 5px 10px rgba(0,0,0,0.5); /* Sombra burbuja */
    }
    .msg-bubble img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
    
    .msg-mio { align-self: flex-end; background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; border-bottom-right-radius: 4px; }
    .msg-otro { align-self: flex-start; background: linear-gradient(135deg, #2c3e50, #34495e); color: #ecf0f1; border-bottom-left-radius: 4px; }
    .msg-name { font-size: 0.7em; opacity: 0.8; margin-bottom: 4px; display: block; font-weight: bold; }
    
    .pdf-attachment { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }

    /* Input Chat */
    .input-bar {
        display: flex; align-items: center; gap: 10px; margin-top: 15px;
        background: var(--card-bg); padding: 5px; border-radius: 30px;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #mensajeInput { flex: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 1em; resize: none; height: 24px; }
    #mensajeInput:focus { outline: none; }
    .action-btn { background: transparent; border: none; color: #888; font-size: 1.2em; cursor: pointer; padding: 0 10px; transition: 0.2s; }
    .action-btn:hover { color: var(--accent); transform: scale(1.2); }

    /* Admin & Utilidades */
    .admin-stats { font-size: 0.9em; display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .stat-tag { background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px; border: 1px solid #444; }
    .hidden { display: none !important; }
    #loginError { color: #e74c3c; margin-top: 10px; min-height: 1.2em; }
    
    .music-btn {
        text-decoration: none; color: var(--gold); background: rgba(212, 175, 55, 0.1);
        padding: 10px 20px; border-radius: 25px; border: 1px solid var(--gold); margin-right: 15px;
        display: inline-block; font-size: 1.5em; transition: 0.3s;
    }
    .music-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); transform: scale(1.1); }
</style>
</head>
<body>

<!-- FACHADA P√öBLICA -->
<div class="container" id="contenedor-publico">
    <h1>El Alma del Jazz</h1>
    <p>El jazz no es solo m√∫sica; es una forma de vida, un reflejo del alma humana en notas improvisadas y ritmos que laten al comp√°s del coraz√≥n. Surgi√≥ a finales del siglo XIX en las calles vibrantes de Nueva Orleans.</p>
    <p>Desde los clubes llenos de humo hasta los grandes escenarios del mundo, el jazz ha evolucionado, pero nunca ha perdido su esencia: la libertad de expresi√≥n.</p>
    
    <h2>Figuras Ic√≥nicas del Jazz</h2>
    <div class="figure">
        <img alt="Frank Sinatra" src="https://i.imgur.com/DgMHCSb.jpeg"/>
        <div class="figure-text">
            <p><strong>Frank Sinatra</strong>, conocido como "La Voz", llev√≥ el jazz a nuevas alturas con su estilo suave en temas como "Fly Me to the Moon".</p>
        </div>
    </div>
    <div class="figure">
        <img alt="Ella Fitzgerald" src="https://i.imgur.com/101yBqK.jpeg"/>
        <div class="figure-text">
            <p><strong>Ella Fitzgerald</strong>, la "Primera Dama de la Canci√≥n", revolucion√≥ el jazz con su voz cristalina. "Summertime" es pura magia.</p>
        </div>
    </div>
    <div class="figure">
        <img alt="Louis Armstrong" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Louis_Armstrong_restored.jpg/220px-Louis_Armstrong_restored.jpg"/>
        <div class="figure-text">
            <p><strong>Louis Armstrong</strong>, apodado "Satchmo". Su interpretaci√≥n de "What a Wonderful World" es un himno de esperanza.</p>
        </div>
    </div>

    <h2>Canciones que Definen el Jazz</h2>
    <ul>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=A3yCcXgbKrE" target="_blank">"What a Wonderful World" - Louis Armstrong</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=u2bigf337aU" target="_blank">"Summertime" - Ella Fitzgerald</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=ZEcqHA7dbwM" target="_blank">"Fly Me to the Moon" - Frank Sinatra</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=vmDDOFXSgAs&amp;pp=ygUJdGFrZSBmaXZl" target="_blank">"Take Five" - Dave Brubeck</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=ylXk1LBvIqU" target="_blank">"So What" - Miles Davis</a></li>
    </ul>

    <h2>Comentarios del Archivo</h2>
    <div id="lista-comentarios">
        <div class="fake-comment">
            <div class="fake-meta"><span class="fake-user">JazzSoul99</span> ‚Ä¢ hace 57 semanas</div>
            <p>Incre√≠ble art√≠culo. La versi√≥n de Louis Armstrong siempre me hace llorar. Gracias por mantener viva esta m√∫sica.</p>
        </div>
        <div class="fake-comment">
            <div class="fake-meta"><span class="fake-user">VinylCollector</span> ‚Ä¢ hace 46 semanas</div>
            <p>Sinatra es insuperable. Me encantar√≠a ver m√°s art√≠culos sobre el periodo Bebop.</p>
        </div>
        <div class="fake-comment">
            <div class="fake-meta"><span class="fake-user">Maria_Keys</span> ‚Ä¢ hace 32 semanas</div>
            <p>Ella Fitzgerald ten√≠a una voz que no era de este mundo. Gran selecci√≥n de canciones.</p>
        </div>
    </div>

    <div class="input-container-public">
        <input type="text" id="mensajeInputPublico" placeholder="A√±ade tu comentario...">
        <button id="enviarMensajePublico">Comentar</button>
    </div>

    <h2>Un Legado Eterno</h2>
    <p>El jazz es un g√©nero que nunca envejece. Es un recordatorio de que la m√∫sica puede ser un refugio, una protesta o una celebraci√≥n.</p>
    <p>Si te apasiona este arte, sum√©rgete en sus ra√≠ces, descubre sus leyendas y d√©jate envolver por sus <a class="secret-link" href="#" id="palabra-secreta">melod√≠as</a>.</p>
</div>

<!-- SECCI√ìN SECRETA (LOGIN + APP) -->
<div id="seccion-secreta">
    
    <!-- LOGIN -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2 style="color:var(--accent); font-family: 'Playfair Display', serif;">Bienvenida</h2>
            <p style="color:#888; font-size:0.9em; margin-bottom:20px;">Espacio reservado para Estrellita y Luna</p>
            
            <input type="email" id="email" class="input-3d" placeholder="Correo electr√≥nico">
            <div style="position:relative;">
                <input type="password" id="password" class="input-3d" placeholder="Contrase√±a">
                <span id="togglePassword" style="position:absolute; right:15px; top:18px; cursor:pointer; color:#666;">üëÅ</span>
            </div>
            
            <button id="login" class="btn-3d">Iniciar Sesi√≥n</button>
            <p id="loginError"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="contenido-secreto" class="app-layout hidden">
        <div class="header-bar">
            <div>
                <h2 style="margin:0; font-family: 'Playfair Display', serif; color:white;">
                    Hola, <span id="nombre-usuario" style="color:var(--accent);">Amor</span> ‚ú®
                </h2>
                <small style="color:#777;">Bienvenida a casa</small>
            </div>
        </div>

        <!-- PANEL ADMIN (Solo Luna) -->
        <div id="admin-info" class="card-3d hidden">
            <h3 style="margin:0; color:var(--gold); margin-bottom:10px;">üëë Panel de Luna</h3>
            <div id="contadores-container" class="admin-stats">Cargando...</div>
        </div>

        <!-- EMOCIONES & M√öSICA -->
        <div class="card-3d">
            <h3 style="margin-top:0; color:#ddd;">¬øC√≥mo te sientes hoy?</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <select id="emocion" class="input-3d" style="flex:1; margin:0; padding:10px;">
                    <option value="feliz">Feliz üòä</option>
                    <option value="triste">Triste üòî</option>
                    <option value="estresada">Estresada üòµ‚Äçüí´</option>
                    <option value="cansada">Cansada ü•±</option>
                    <option value="extra√±andote">Extra√±√°ndote ü•∫</option>
                    <option value="pensandoEnTi">Pensando en ti üí≠‚ù§Ô∏è</option>
                    <option value="conGanasDeVerte">Con ganas de verte ü•∞</option>
                    <option value="conGanasDePensar">Con ganas de "pensar" üòè</option>
                </select>
                <button onclick="mostrarMensaje()" class="btn-3d" style="width:auto; margin:0; padding:10px 20px;">Ver Mensaje</button>
            </div>
            <div id="mensaje" style="margin-top:15px; padding:15px; border-left:3px solid var(--accent); background:rgba(142, 68, 173, 0.1); color:var(--accent); font-style:italic; display:none;"></div>
            
            <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <!-- Nuevos enlaces de m√∫sica -->
                    <a href="https://www.youtube.com/watch?v=zgaCZOQCpp8&pp=ygUQZGllIHdpdGggYSBzbWlsZQ%3D%3D" target="_blank" class="music-btn" title="From The Start">
                        <i class="fas fa-music"></i> <i class="fas fa-heart"></i>
                    </a>
                    <a href="https://www.youtube.com/watch?v=rHvQakk1zMA&pp=ygUOZnJvbSB0aGUgc3RhcnQ%3D" target="_blank" class="music-btn" title="Nuestra Canci√≥n">
                        <i class="fas fa-music"></i> <i class="fas fa-heart"></i>
                    </a>
                </div>
                <button onclick="mostrarPoema()" style="background:none; border:none; color:#777; cursor:pointer;">üìú Poema</button>
            </div>
            <div id="poema" style="margin-top:10px; color:var(--gold); font-style:italic; white-space:pre-wrap; font-size:0.9em; display:none;"></div>
        </div>

        <!-- CHAT CON IM√ÅGENES -->
        <div class="card-3d" style="border: 1px solid var(--accent);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color:var(--accent);">Nuestro Chat Privado</h3>
            </div>
            
            <!-- Botones de Gesti√≥n (Encima del chat) -->
            <div class="chat-header-actions">
                <button id="logout" class="btn-secondary" style="padding:5px 10px; border-radius:5px; color:white; border:none; cursor:pointer;">Cerrar Sesi√≥n</button>
                <button id="borrarChatBtn" class="hidden" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Borrar Chat</button>
            </div>

            <div id="chat" class="chat-window"></div>
            
            <div class="input-bar">
                <input type="file" id="imageInput" accept="image/*, application/pdf" style="display:none;">
                <button id="btnUpload" class="action-btn" title="Adjuntar"><i class="fas fa-paperclip"></i></button>
                <textarea id="mensajeInput" placeholder="Escribe un mensaje..."></textarea>
                <button id="enviarMensaje" class="action-btn" style="color:var(--accent);"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- LOGICA LOCAL -->
<script>
    // 1. Frases y Poemas
    const FRASES = {
        feliz: ["Tu sonrisa ilumina mi oscuridad.", "Me encanta verte brillar.", "Guarda este momento en tu coraz√≥n."],
        triste: ["Estoy aqu√≠, sosteniendo tu mano.", "Esto tambi√©n pasar√°, mi amor.", "Eres m√°s fuerte de lo que crees."],
        estresada: ["Respira. Inhala, exhala.", "T√≥mate un descanso, el mundo espera.", "Imagina que te abrazo."],
        cansada: ["Descansa, guerrera.", "Deja que el sue√±o repare tus alas.", "Buenas noches, mi vida."],
        extra√±andote: ["Yo te extra√±o m√°s.", "Mi alma est√° contigo.", "Pronto nos veremos."],
        pensandoEnTi: ["Vives en mi mente 24/7.", "Eres mi pensamiento favorito.", "Yo tambi√©n pensaba en ti."],
        conGanasDeVerte: ["Cuento los segundos.", "Un abrazo tuyo lo cura todo.", "Ya falta menos."],
        conGanasDePensar: ["Mente sucia, coraz√≥n contento üòè", "Me encanta cuando te pones as√≠.", "Tengo las mismas ganas."]
    };
    const POEMAS = [
        "ENTRE N√öMEROS Y LETRAS\n\nEntre n√∫meros y letras\nsurgi√≥ una rosa en una libreta.\nEntre ecuaciones y canciones\nsurgieron nuestros amores.",
        "TOMA MI MANO\n\nToma mi mano,\ny acomp√°√±ame al camino\nde la vida.",
        "AMOR ETERNO\n\nPodr√° nublarse el sol eternamente;\nPodr√° secarse en un instante el mar;\nPero jam√°s en m√≠ podr√° apagarse\nLa llama de tu amor."
    ];

    function mostrarMensaje() {
        const emocion = document.getElementById('emocion').value;
        const lista = FRASES[emocion] || ["Te quiero."];
        const frase = lista[Math.floor(Math.random() * lista.length)];
        const div = document.getElementById('mensaje');
        div.textContent = frase; div.style.display = 'block';
        document.dispatchEvent(new CustomEvent('emocionRegistrada', { detail: emocion }));
    }

    function mostrarPoema() {
        const div = document.getElementById('poema');
        div.textContent = POEMAS[Math.floor(Math.random() * POEMAS.length)];
        div.style.display = 'block';
    }

    // 2. Trigger Secreto
    document.getElementById('palabra-secreta').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('seccion-secreta').style.display = 'block';
    });

    document.getElementById('togglePassword').addEventListener('click', () => {
        const inp = document.getElementById('password');
        inp.type = inp.type === "password" ? "text" : "password";
    });

    // 3. Comentarios P√∫blicos Locales
    document.getElementById('enviarMensajePublico').addEventListener('click', () => {
        const txt = document.getElementById('mensajeInputPublico').value;
        if(txt) {
            const div = document.createElement('div');
            div.className = 'fake-comment nuevo-comentario';
            div.innerHTML = `<div class="fake-meta"><span class="fake-user">Usuario</span> ‚Ä¢ ahora mismo</div><p>${txt}</p>`;
            document.getElementById('lista-comentarios').appendChild(div);
            document.getElementById('mensajeInputPublico').value = '';
        }
    });
</script>

<!-- L√ìGICA FIREBASE Y EMAILJS -->
<!-- SCRIPT 2: EL CEREBRO DE LA NUBE (FIREBASE) - VERSI√ìN FINAL TIEMPO REAL -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, get, set, onValue, serverTimestamp, remove, query, limitToLast, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- TUS CREDENCIALES ---
    const firebaseConfig = {
        apiKey: "AIzaSyAcweOs5qS3v4xbzmkYCFLKxVaSWVsly_M",
        authDomain: "estrellita-chl.firebaseapp.com",
        databaseURL: "https://estrellita-chl-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "estrellita-chl",
        storageBucket: "estrellita-chl.firebasestorage.app",
        messagingSenderId: "1006618062076",
        appId: "1:1006618062076:web:8cc3a6bb3ebe800d11fb79",
        measurementId: "G-X2K8ZCR608"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const USUARIO_ESTRELLITA = "oras5982";
    const USUARIO_ADMIN = "jahaziel.alvarezreyes";

    // Inicializar EmailJS
    (function(){
        if(window.emailjs) emailjs.init("8SKjsqXHTpjoSMWRw");
    })();

    function enviarNotificacionEmail() {
        if(!window.emailjs) return;
        const params = {
            message: 'Inicio de sesi√≥n detectado',
            to_email: 'emailjsoras@gmail.com',
            date: new Date().toLocaleString()
        };
        emailjs.send('service_poil498', 'template_wyew1g2', params)
            .catch(err => console.error("Error email", err));
    }

    const dom = {
        login: document.getElementById('login'),
        logout: document.getElementById('logout'),
        email: document.getElementById('email'),
        pass: document.getElementById('password'),
        loginBox: document.getElementById('loginContainer'),
        appBox: document.getElementById('contenido-secreto'),
        chat: document.getElementById('chat'),
        input: document.getElementById('mensajeInput'),
        send: document.getElementById('enviarMensaje'),
        fileBtn: document.getElementById('btnUpload'),
        fileInp: document.getElementById('imageInput'),
        error: document.getElementById('loginError'),
        borrarBtn: document.getElementById('borrarChatBtn')
    };

    let currentUser = null;
    let mensajesVistos = new Set();
    let sesionGuardada = false; // Bandera para evitar dobles registros

    // --- L√ìGICA DE REGISTRO DE TIEMPO (CORREGIDA) ---

    function registrarEntrada(nombreUsuario) {
        // Si no hay un inicio guardado en la memoria temporal, lo guardamos ahora
        if (!sessionStorage.getItem('inicioSesion')) {
            const ahora = Date.now();
            sessionStorage.setItem('inicioSesion', ahora);
            sessionStorage.setItem('usuarioSesion', nombreUsuario);
            
            // Registrar el acceso en Firebase solo una vez al entrar
            push(ref(db, 'accesos'), {
                usuario: nombreUsuario,
                fecha: new Date().toLocaleString(),
                timestamp: serverTimestamp()
            });
        }
    }

    function registrarSalida() {
        // Recuperamos el tiempo de inicio de la memoria
        const inicio = sessionStorage.getItem('inicioSesion');
        const usuario = sessionStorage.getItem('usuarioSesion');

        if (inicio && usuario && !sesionGuardada) {
            const fin = Date.now();
            const duracionMs = fin - parseInt(inicio);
            const minutos = (duracionMs / 1000 / 60).toFixed(2);

            // Solo guardamos si ha estado m√°s de 5 segundos (evita rebotes)
            if (duracionMs > 5000) {
                push(ref(db, 'tiempoSesiones'), {
                    usuario: usuario,
                    inicio: new Date(parseInt(inicio)).toLocaleString(),
                    fin: new Date(fin).toLocaleString(),
                    duracionMinutos: minutos + " min",
                    timestamp: serverTimestamp()
                });
                console.log("Sesi√≥n finalizada y guardada:", minutos, "minutos");
            }
            
            sesionGuardada = true; // Marcamos como guardada
            sessionStorage.removeItem('inicioSesion'); // Limpiamos memoria
        }
    }

    // Este evento se dispara SOLO cuando se cierra la pesta√±a o se sale de la p√°gina
    window.addEventListener('pagehide', () => {
        registrarSalida();
    });

    // --- AUTENTICACI√ìN ---
    
    dom.login.addEventListener('click', () => {
        const e = dom.email.value;
        const p = dom.pass.value;
        dom.error.textContent = "";
        
        enviarNotificacionEmail();

        signInWithEmailAndPassword(auth, e, p).catch(err => {
            console.error(err);
            dom.error.textContent = "Error: Verifica tus datos.";
        });
    });

    dom.logout.addEventListener('click', () => {
        registrarSalida(); // Guardamos el tiempo al dar click expl√≠citamente
        signOut(auth).then(() => {
            sessionStorage.clear(); // Limpieza total
            location.reload();
        });
    });

    onAuthStateChanged(auth, (user) => {
        if(user) {
            currentUser = user;
            const short = user.email.split('@')[0];
            const name = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
            document.getElementById('nombre-usuario').textContent = name;
            
            // Iniciamos el contador (o recuperamos el existente si recarg√≥)
            sesionGuardada = false; 
            registrarEntrada(name);

            dom.loginBox.style.display = 'none';
            dom.appBox.classList.remove('hidden');
            
            iniciarChat();

            if(short === USUARIO_ADMIN) {
                document.getElementById('admin-info').classList.remove('hidden');
                dom.borrarBtn.classList.remove('hidden');
                iniciarContadores();
                
                dom.borrarBtn.onclick = () => {
                    if(confirm("¬øEst√°s segura de borrar TODO el chat? No hay vuelta atr√°s.")) {
                        remove(ref(db, 'mensajes'));
                    }
                };
            }
            
            // Listener Emociones (Solo guarda, no afecta al tiempo)
            document.addEventListener('emocionRegistrada', (e) => {
                if(short === USUARIO_ESTRELLITA) {
                    const emo = e.detail;
                    const cRef = ref(db, `contadores/${emo}`);
                    get(cRef).then(s => set(cRef, (s.val()||0)+1));
                    push(ref(db, 'historialEmociones'), {
                        emocion: emo, usuario: name, timestamp: serverTimestamp(), fecha: new Date().toLocaleString()
                    });
                }
            });

        } else {
            dom.loginBox.style.display = 'flex';
            dom.appBox.classList.add('hidden');
        }
    });

    // --- CHAT L√ìGICA ---
    function iniciarChat() {
        const chatRef = ref(db, 'mensajes');
        dom.chat.innerHTML = '';
        mensajesVistos.clear();
        
        onChildAdded(query(chatRef, orderByChild('timestamp'), limitToLast(50)), (snap) => {
            if(mensajesVistos.has(snap.key)) return;
            mensajesVistos.add(snap.key);
            renderMsg(snap.val());
        });

        onValue(chatRef, (snap) => {
            if(!snap.exists()) { dom.chat.innerHTML = ''; mensajesVistos.clear(); }
        });
    }

    function renderMsg(data) {
        if(!currentUser) return;
        const short = currentUser.email.split('@')[0];
        const miNombre = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
        const esMio = data.usuario === miNombre;
        
        const div = document.createElement('div');
        div.className = `msg-bubble ${esMio ? 'msg-mio' : 'msg-otro'}`;
        
        let content = '';
        if(data.tipo === 'imagen') content = `<img src="${data.mensaje}">`;
        else if(data.tipo === 'pdf') content = `<div class="pdf-attachment"><i class="fas fa-file-pdf"></i> <a href="${data.mensaje}" download="${data.nombreArchivo}" style="color:white;">${data.nombreArchivo}</a></div>`;
        else content = data.mensaje.replace(/\n/g, '<br>');

        div.innerHTML = `<span class="msg-name">${data.usuario}</span>${content}`;
        dom.chat.appendChild(div);
        requestAnimationFrame(() => dom.chat.scrollTop = dom.chat.scrollHeight);
    }

    // --- ENVIAR ---
    dom.send.addEventListener('click', enviarTexto);
    dom.input.addEventListener('keypress', (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); enviarTexto(); } });

    function enviarTexto() {
        const txt = dom.input.value.trim();
        if(!txt) return;
        enviar(txt, 'texto');
        dom.input.value = '';
    }

    dom.fileBtn.addEventListener('click', () => dom.fileInp.click());
    dom.fileInp.addEventListener('change', function(e) {
        const f = e.target.files[0];
        if(!f) return;
        const isPdf = f.type === 'application/pdf';
        if(f.size > (isPdf?0.5:5)*1024*1024) { alert("Archivo muy grande"); return; }
        
        const r = new FileReader();
        if(f.type.startsWith('image/')) {
            r.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d');
                    const scale = 500/img.width;
                    c.width = 500; c.height = img.height*scale;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    enviar(c.toDataURL('image/jpeg',0.7), 'imagen');
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        } else if(isPdf) {
            r.onload = (ev) => enviar(ev.target.result, 'pdf', f.name);
            r.readAsDataURL(f);
        }
        this.value = '';
    });

    function enviar(cont, tipo, nombre=null) {
        const short = currentUser.email.split('@')[0];
        const name = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
        push(ref(db, 'mensajes'), {
            usuario: name, mensaje: cont, tipo: tipo, nombreArchivo: nombre, timestamp: serverTimestamp()
        });
    }

    // --- ADMIN ---
    function iniciarContadores() {
        onValue(ref(db, 'contadores'), (snap) => {
            const d = snap.val();
            const div = document.getElementById('contadores-container');
            if(!d) { div.innerHTML = "Sin datos."; return; }
            div.innerHTML = '';
            Object.entries(d).forEach(([k,v]) => {
                div.innerHTML += `<span class="stat-tag">${k}: <strong style="color:var(--gold)">${v}</strong></span>`;
            });
        });
    }
</script>
</body>

</html>
