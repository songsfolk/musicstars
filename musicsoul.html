<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>El Alma del Jazz</title>
<!-- Iconos FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
    /* =========================================
       ESTILOS ORIGINALES (FACHADA P√öBLICA)
       ========================================= */
    body {
        font-family: 'Georgia', serif;
        background-color: #1e1e1e;
        color: #f0e6d2;
        margin: 0;
        padding: 20px;
        line-height: 1.6;
    }

    h1 { text-align: center; color: #d4af37; font-size: 2.5em; margin-bottom: 20px; }
    h2 { color: #d4af37; font-size: 1.8em; margin-top: 30px; }
    
    .container {
        max-width: 900px; margin: 0 auto;
        background-color: #2b2b2b; padding: 30px;
        border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    p { font-size: 1.1em; margin: 15px 0; }
    .figure { display: flex; align-items: center; margin: 20px 0; }
    .figure img { width: 150px; height: 150px; object-fit: cover; border-radius: 50%; margin-right: 20px; border: 2px solid #d4af37; }
    .figure-text { flex: 1; }
    
    ul { list-style-type: none; padding: 0; }
    li { margin: 10px 0; font-style: italic; }
    a.song-link { color: #87ceeb; text-decoration: none; }
    a.song-link:hover { color: #b0e0e6; text-decoration: underline; }

    /* EL SECRETO: Camuflaje perfecto */
    a.secret-link { 
        color: inherit; text-decoration: none; cursor: text; 
    }
    a.secret-link:hover { color: inherit; text-decoration: none; }

    /* Comentarios Fake Est√°ticos */
    .fake-comment { border-bottom: 1px solid #444; padding: 15px 0; }
    .fake-meta { font-size: 0.8em; color: #888; margin-bottom: 5px; }
    .fake-user { color: #d4af37; font-weight: bold; }
    .nuevo-comentario { animation: highlight 2s; }
    @keyframes highlight { from { background: #333; } to { background: transparent; } }

    /* Inputs P√∫blicos */
    .input-container-public { display: flex; margin-top: 20px; gap: 10px; }
    #mensajeInputPublico { flex: 1; background: #f0e6d2; border: none; padding: 10px; border-radius: 5px; font-family: 'Georgia', serif; }
    #enviarMensajePublico { background: #d4af37; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }

    @media (max-width: 600px) {
        h1 { font-size: 2em; }
        .figure { flex-direction: column; text-align: center; }
        .figure img { margin: 0 0 10px 0; width: 120px; height: 120px; }
    }

    /* =========================================
       SECCI√ìN SECRETA (3D + APP)
       ========================================= */
    :root {
        --bg-deep: #050508;
        --card-bg: #14141a;
        --accent: #9b59b6;
        --gold: #d4af37;
        --shadow-3d: 0 15px 30px rgba(0,0,0,0.7), 0 5px 15px rgba(0,0,0,0.5);
        --shadow-inset: inset 3px 3px 7px rgba(0,0,0,0.8), inset -2px -2px 5px rgba(255,255,255,0.05);
    }

    #seccion-secreta {
        display: none;
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: radial-gradient(circle at center, #1a1a24 0%, #050508 100%);
        z-index: 9999; overflow-y: auto;
        font-family: 'Inter', 'Segoe UI', sans-serif;
    }

    /* Login 3D */
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; perspective: 1500px; }
    .login-box {
        background: var(--card-bg); padding: 40px; border-radius: 20px;
        width: 90%; max-width: 380px; text-align: center;
        box-shadow: var(--shadow-3d); border: 1px solid rgba(255,255,255,0.05);
        transform: rotateX(5deg) rotateY(-2deg);
        transition: transform 0.3s;
    }
    .login-box:hover { transform: rotateX(0) rotateY(0) scale(1.02); }
    
    .input-3d {
        width: 100%; padding: 15px; margin: 10px 0; background: #0a0a0e;
        border: none; border-radius: 12px; color: #fff; box-shadow: var(--shadow-inset);
        box-sizing: border-box; font-size: 16px;
    }
    .input-3d:focus { outline: none; box-shadow: 0 0 0 2px var(--accent); }

    .btn-3d {
        background: linear-gradient(145deg, #8e44ad, #5e3370); color: white; border: none;
        padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer;
        width: 100%; margin-top: 15px; 
        box-shadow: 0 8px 15px rgba(142, 68, 173, 0.4), 0 4px 4px rgba(0,0,0,0.5);
        transition: transform 0.1s, box-shadow 0.1s;
        transform: translateY(-2px);
    }
    .btn-3d:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    .btn-secondary { background: #333; width: auto; font-size: 0.8em; box-shadow: none; margin: 0; transform: none; }

    /* App Layout */
    .app-layout { max-width: 850px; margin: 0 auto; padding: 20px; color: #ddd; perspective: 1000px; }
    .header-bar {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;
    }

    .card-3d {
        background: var(--card-bg); border-radius: 15px; padding: 25px; margin-bottom: 25px;
        box-shadow: var(--shadow-3d); border: 1px solid rgba(255,255,255,0.05);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: translateZ(0);
    }
    .card-3d:hover { transform: translateY(-8px) scale(1.01); }

    /* Botones M√∫sica */
    .music-btn {
        text-decoration: none; color: var(--gold); background: rgba(212, 175, 55, 0.1);
        padding: 10px 20px; border-radius: 25px; border: 1px solid var(--gold); margin-right: 15px;
        display: inline-block; font-size: 1.5em; transition: 0.3s;
    }
    .music-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); transform: scale(1.1); }

    /* Admin */
    .admin-stats { font-size: 0.9em; display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .stat-tag { background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px; border: 1px solid #444; }
    .hidden { display: none !important; }
    #loginError { color: #e74c3c; margin-top: 10px; min-height: 1.2em; }

    /* =====================
       CHAT MODERNO (NUEVO)
       ===================== */
    .chat-header-actions {
        display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;
    }
    .btn-small {
        background: #333; color: #ccc; border: none; padding: 6px 12px;
        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
    }
    .btn-danger { background: #c0392b; color: white; }

    .chat-window {
        background: #09090c; height: 450px; border-radius: 12px; padding: 20px;
        overflow-y: auto; display: flex; flex-direction: column; gap: 6px;
        background-image: radial-gradient(#1f1f1f 1px, transparent 1px); background-size: 24px 24px;
        scrollbar-width: thin; scrollbar-color: #333 transparent;
    }

    /* Filas y Burbujas */
    .msg-row { display: flex; width: 100%; position: relative; margin-bottom: 4px; }
    .msg-row.me { justify-content: flex-end; }
    .msg-row.other { justify-content: flex-start; }

    .msg-content-wrapper {
        max-width: 80%; display: flex; align-items: flex-end; gap: 8px; position: relative;
        transition: transform 0.3s ease;
    }
    .msg-row.me .msg-content-wrapper { flex-direction: row-reverse; }

    .bubble {
        padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
        position: relative; word-wrap: break-word;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3); user-select: none;
        -webkit-user-select: none;
        touch-action: pan-y;
        cursor: default;
    }
    /* Asegura que los hijos no bloqueen el contextmenu */
    .bubble * { pointer-events: none; }
    .bubble .reaction-menu { pointer-events: all; }
    .bubble .reaction-menu .emoji-opt { pointer-events: all; }
    .bubble a { pointer-events: all; }
    .msg-row.me .bubble {
        background: linear-gradient(135deg, #7F00FF 0%, #E100FF 100%);
        color: white; border-bottom-right-radius: 2px;
    }
    .msg-row.other .bubble {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: #e0e0e0; border-bottom-left-radius: 2px;
    }
    .bubble img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

    /* Swipe indicator */
    .swipe-reply-indicator {
        position: absolute;
        top: 50%; transform: translateY(-50%);
        color: var(--accent); font-size: 1.2rem;
        opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .msg-row.me .swipe-reply-indicator { left: -35px; }
    .msg-row.other .swipe-reply-indicator { right: -35px; }

    /* Contexto de Respuesta */
    .reply-context {
        background: rgba(0,0,0,0.2); border-left: 3px solid rgba(255,255,255,0.7);
        border-radius: 4px; padding: 4px 8px; margin-bottom: 6px;
        font-size: 0.8rem; display: flex; flex-direction: column;
    }
    .reply-user { font-weight: 700; font-size: 0.75rem; opacity: 0.9; }
    .reply-text { font-style: italic; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Badge Reacci√≥n */
    .reaction-badge {
        position: absolute; bottom: -10px;
        background: #2b2b36; border: 2px solid #0b0b0b;
        border-radius: 12px; padding: 2px 6px; font-size: 0.85rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.4); z-index: 5;
        cursor: pointer;
    }
    .msg-row.me .reaction-badge { left: -5px; }
    .msg-row.other .reaction-badge { right: -5px; }

    /* Men√∫ r√°pido de Emojis (burbuja compacta) */
    .reaction-menu {
        display: none; position: absolute; bottom: calc(100% + 12px);
        background: #1e1e26; border: 1px solid #444; padding: 7px 10px;
        border-radius: 50px; gap: 6px; box-shadow: 0 8px 25px rgba(0,0,0,0.8);
        z-index: 300; pointer-events: all;
        animation: popUp 0.18s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        align-items: center;
    }
    .msg-row.me .reaction-menu { right: 0; }
    .msg-row.other .reaction-menu { left: 0; }
    .reaction-menu.active { display: flex; }
    @keyframes popUp { from { transform: scale(0.5) translateY(8px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
    .emoji-opt { font-size: 1.4rem; cursor: pointer; transition: transform 0.15s; display: inline-block; pointer-events: all !important; line-height: 1; }
    .emoji-opt:hover, .emoji-opt:active { transform: scale(1.5); }

    /* Bot√≥n "+" para abrir el panel completo */
    .emoji-more-btn {
        width: 30px; height: 30px; border-radius: 50%;
        background: #333; border: 1px solid #555;
        color: #bbb; font-size: 1.1rem; font-weight: bold;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        pointer-events: all !important; flex-shrink: 0;
        transition: background 0.2s, color 0.2s;
    }
    .emoji-more-btn:hover, .emoji-more-btn:active { background: var(--accent); color: white; }

    /* Panel completo de emojis (overlay central) */
    #emoji-full-panel {
        display: none; position: fixed; bottom: 0; left: 0; right: 0;
        background: #18181f; border-top: 2px solid var(--accent);
        border-radius: 20px 20px 0 0; padding: 16px 12px 24px;
        z-index: 10000; max-height: 55vh; overflow: hidden;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.9);
        animation: slideUpPanel 0.25s ease;
        flex-direction: column; gap: 10px;
    }
    #emoji-full-panel.active { display: flex; }
    @keyframes slideUpPanel { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    #emoji-full-panel-header {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 10px; border-bottom: 1px solid #333; flex-shrink: 0;
    }
    #emoji-full-panel-header span { color: #aaa; font-size: 0.85rem; font-family: 'Inter', sans-serif; }
    #emoji-full-panel-close {
        background: #333; border: none; color: #ccc; width: 28px; height: 28px;
        border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex;
        align-items: center; justify-content: center; pointer-events: all;
    }
    #emoji-full-grid {
        display: grid; grid-template-columns: repeat(8, 1fr);
        gap: 4px; overflow-y: auto; padding-right: 4px;
        max-height: calc(55vh - 80px);
    }
    #emoji-full-grid::-webkit-scrollbar { width: 4px; }
    #emoji-full-grid::-webkit-scrollbar-track { background: transparent; }
    #emoji-full-grid::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
    .emoji-full-opt {
        font-size: 1.6rem; text-align: center; cursor: pointer;
        padding: 6px 2px; border-radius: 8px; transition: background 0.1s;
        pointer-events: all; line-height: 1.2;
    }
    .emoji-full-opt:hover, .emoji-full-opt:active { background: rgba(155,89,182,0.3); }

    /* Overlay oscuro detr√°s del panel */
    #emoji-panel-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(0,0,0,0.6); z-index: 9999;
    }
    #emoji-panel-overlay.active { display: block; }

    /* Bot√≥n Responder */
    .reply-action-btn {
        opacity: 0; color: #777; font-size: 1rem; cursor: pointer; padding: 5px;
        transition: all 0.2s ease; flex-shrink: 0;
    }
    .msg-content-wrapper:hover .reply-action-btn { opacity: 1; }
    .reply-action-btn:hover { color: var(--accent); transform: scale(1.1); }

    /* Preview Reply Bar */
    #reply-preview-bar {
        display: none; background: #1a1a20; padding: 8px 12px;
        border-top: 2px solid var(--accent);
        justify-content: space-between; align-items: center; font-size: 0.85rem;
        animation: slideUp 0.2s ease;
    }
    @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Input Bar */
    .input-bar {
        display: flex; align-items: center; gap: 10px; margin-top: 10px;
        background: var(--card-bg); padding: 6px; border-radius: 30px;
        border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #mensajeInput { flex: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 1rem; resize: none; height: 24px; outline: none; }
    .action-btn { background: transparent; border: none; color: #888; font-size: 1.2rem; cursor: pointer; padding: 0 10px; transition: 0.2s; }
    .action-btn:hover { color: var(--accent); transform: scale(1.1); }

    .pdf-attachment { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; }
    .msg-name { font-size: 0.7em; opacity: 0.6; margin-bottom: 2px; display: block; font-weight: bold; }
    .msg-row.me .msg-name { display: none; }

    /* Men√∫ contextual personalizado para desktop */
    #custom-context-menu {
        position: fixed;
        background: #1e1e24;
        border: 1px solid #555;
        border-radius: 50px;
        padding: 8px 12px;
        display: none;
        flex-wrap: wrap;
        gap: 6px;
        z-index: 99999;
        box-shadow: 0 8px 25px rgba(0,0,0,0.9);
        pointer-events: all;
        max-width: 90vw;
    }
    #custom-context-menu.active { display: flex; }
    #custom-context-menu .emoji-opt { font-size: 1.4rem; cursor: pointer; transition: transform 0.15s; display: inline-block; line-height: 1; }
    #custom-context-menu .emoji-opt:hover { transform: scale(1.5); }
</style>
</head>
<body>

<!-- MEN√ö CONTEXTUAL GLOBAL (DESKTOP - CLIC DERECHO) -->
<div id="custom-context-menu"></div>

<!-- PANEL COMPLETO DE EMOJIS (M√ìVIL - BOT√ìN +) -->
<div id="emoji-panel-overlay"></div>
<div id="emoji-full-panel">
    <div id="emoji-full-panel-header">
        <span>Elige una reacci√≥n</span>
        <button id="emoji-full-panel-close">‚úï</button>
    </div>
    <div id="emoji-full-grid"></div>
</div>

<!-- FACHADA P√öBLICA -->
<div class="container" id="contenedor-publico">
    <h1>El Alma del Jazz</h1>
    <p>El jazz no es solo m√∫sica; es una forma de vida, un reflejo del alma humana en notas improvisadas y ritmos que laten al comp√°s del coraz√≥n. Surgi√≥ a finales del siglo XIX en las calles vibrantes de Nueva Orleans.</p>
    <p>Desde los clubes llenos de humo hasta los grandes escenarios del mundo, el jazz ha evolucionado, pero nunca ha perdido su esencia: la libertad de expresi√≥n.</p>
    
    <h2>Figuras Ic√≥nicas del Jazz</h2>
    <div class="figure">
        <img alt="Frank Sinatra" src="https://i.imgur.com/DgMHCSb.jpeg"/>
        <div class="figure-text">
            <p><strong>Frank Sinatra</strong>, conocido como "La Voz", llev√≥ el jazz a nuevas alturas con su estilo suave en temas como "Fly Me to the Moon".</p>
        </div>
    </div>
    <div class="figure">
        <img alt="Ella Fitzgerald" src="https://i.imgur.com/101yBqK.jpeg"/>
        <div class="figure-text">
            <p><strong>Ella Fitzgerald</strong>, la "Primera Dama de la Canci√≥n", revolucion√≥ el jazz con su voz cristalina. "Summertime" es pura magia.</p>
        </div>
    </div>
    <div class="figure">
        <img alt="Louis Armstrong" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Louis_Armstrong_restored.jpg/220px-Louis_Armstrong_restored.jpg"/>
        <div class="figure-text">
            <p><strong>Louis Armstrong</strong>, apodado "Satchmo". Su interpretaci√≥n de "What a Wonderful World" es un himno de esperanza.</p>
        </div>
    </div>

    <h2>Canciones que Definen el Jazz</h2>
    <ul>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=A3yCcXgbKrE" target="_blank">"What a Wonderful World" - Louis Armstrong</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=u2bigf337aU" target="_blank">"Summertime" - Ella Fitzgerald</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=ZEcqHA7dbwM" target="_blank">"Fly Me to the Moon" - Frank Sinatra</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=vmDDOFXSgAs&pp=ygUJdGFrZSBmaXZl" target="_blank">"Take Five" - Dave Brubeck</a></li>
        <li><a class="song-link" href="https://www.youtube.com/watch?v=ylXk1LBvIqU" target="_blank">"So What" - Miles Davis</a></li>
    </ul>

    <h2>Comentarios del Archivo</h2>
    <div id="lista-comentarios">
        <div class="fake-comment">
            <div class="fake-meta"><span class="fake-user">JazzSoul99</span> ‚Ä¢ hace 57 semanas</div>
            <p>Incre√≠ble art√≠culo. La versi√≥n de Louis Armstrong siempre me hace llorar. Gracias por mantener viva esta m√∫sica.</p>
        </div>
        <div class="fake-comment">
            <div class="fake-meta"><span class="fake-user">VinylCollector</span> ‚Ä¢ hace 46 semanas</div>
            <p>Sinatra es insuperable. Me encantar√≠a ver m√°s art√≠culos sobre el periodo Bebop.</p>
        </div>
        <div class="fake-comment">
            <div class="fake-meta"><span class="fake-user">Maria_Keys</span> ‚Ä¢ hace 32 semanas</div>
            <p>Ella Fitzgerald ten√≠a una voz que no era de este mundo. Gran selecci√≥n de canciones.</p>
        </div>
    </div>

    <div class="input-container-public">
        <input type="text" id="mensajeInputPublico" placeholder="A√±ade tu comentario...">
        <button id="enviarMensajePublico">Comentar</button>
    </div>

    <h2>Un Legado Eterno</h2>
    <p>El jazz es un g√©nero que nunca envejece. Es un recordatorio de que la m√∫sica puede ser un refugio, una protesta o una celebraci√≥n.</p>
    <p>Si te apasiona este arte, sum√©rgete en sus ra√≠ces, descubre sus leyendas y d√©jate envolver por sus <a class="secret-link" href="#" id="palabra-secreta">melod√≠as</a>.</p>
</div>

<!-- SECCI√ìN SECRETA (LOGIN + APP) -->
<div id="seccion-secreta">
    
    <!-- LOGIN -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2 style="color:var(--accent); font-family: 'Playfair Display', serif;">Bienvenida</h2>
            <p style="color:#888; font-size:0.9em; margin-bottom:20px;">Espacio reservado para Estrellita y Luna</p>
            
            <input type="email" id="email" class="input-3d" placeholder="Correo electr√≥nico">
            <div style="position:relative;">
                <input type="password" id="password" class="input-3d" placeholder="Contrase√±a">
                <span id="togglePassword" style="position:absolute; right:15px; top:18px; cursor:pointer; color:#666;">üëÅ</span>
            </div>
            
            <button id="login" class="btn-3d">Iniciar Sesi√≥n</button>
            <p id="loginError"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="contenido-secreto" class="app-layout hidden">
        <div class="header-bar">
            <div>
                <h2 style="margin:0; font-family: 'Playfair Display', serif; color:white;">
                    Hola, <span id="nombre-usuario" style="color:var(--accent);">Amor</span> ‚ú®
                </h2>
                <small style="color:#777;">Bienvenida a casa</small>
            </div>
        </div>

        <!-- PANEL ADMIN (Solo Luna) -->
        <div id="admin-info" class="card-3d hidden">
            <h3 style="margin:0; color:var(--gold); margin-bottom:10px;">üëë Panel de Luna</h3>
            <div id="contadores-container" class="admin-stats">Cargando...</div>
        </div>

        <!-- EMOCIONES & M√öSICA -->
        <div class="card-3d">
            <h3 style="margin-top:0; color:#ddd;">¬øC√≥mo te sientes hoy?</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <select id="emocion" class="input-3d" style="flex:1; margin:0; padding:10px;">
                    <option value="feliz">Feliz üòä</option>
                    <option value="triste">Triste üòî</option>
                    <option value="estresada">Estresada üòµ‚Äçüí´</option>
                    <option value="cansada">Cansada ü•±</option>
                    <option value="extra√±andote">Extra√±√°ndote ü•∫</option>
                    <option value="pensandoEnTi">Pensando en ti üí≠‚ù§Ô∏è</option>
                    <option value="conGanasDeVerte">Con ganas de verte ü•∞</option>
                    <option value="conGanasDePensar">Con ganas de "pensar" üòè</option>
                </select>
                <button onclick="mostrarMensaje()" class="btn-3d" style="width:auto; margin:0; padding:10px 20px;">Ver Mensaje</button>
            </div>
            <div id="mensaje" style="margin-top:15px; padding:15px; border-left:3px solid var(--accent); background:rgba(142, 68, 173, 0.1); color:var(--accent); font-style:italic; display:none;"></div>
            
            <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <a href="https://www.youtube.com/watch?v=zgaCZOQCpp8&pp=ygUQZGllIHdpdGggYSBzbWlsZQ%3D%3D" target="_blank" class="music-btn" title="From The Start">
                        <i class="fas fa-music"></i> <i class="fas fa-heart"></i>
                    </a>
                    <a href="https://www.youtube.com/watch?v=rHvQakk1zMA&pp=ygUOZnJvbSB0aGUgc3RhcnQ%3D" target="_blank" class="music-btn" title="Nuestra Canci√≥n">
                        <i class="fas fa-music"></i> <i class="fas fa-heart"></i>
                    </a>
                </div>
                <button onclick="mostrarPoema()" style="background:none; border:none; color:#777; cursor:pointer;">üìú Poema</button>
            </div>
            <div id="poema" style="margin-top:10px; color:var(--gold); font-style:italic; white-space:pre-wrap; font-size:0.9em; display:none;"></div>
        </div>

        <!-- CHAT PRIVADO (NUEVO ESTILO) -->
        <div class="card-3d" style="border: 1px solid var(--accent); padding:0; overflow:hidden;">
            <!-- Cabecera del Chat -->
            <div style="padding:15px 20px; background:#1a1a20; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--accent); font-size:1rem;">üí¨ Nuestro Chat Privado</h3>
                <div class="chat-header-actions" style="margin:0;">
                    <button id="logout" class="btn-small">Cerrar Sesi√≥n</button>
                    <button id="borrarChatBtn" class="btn-small btn-danger hidden">Borrar Chat</button>
                </div>
            </div>

            <!-- Ventana de mensajes -->
            <div id="chat" class="chat-window"></div>

            <!-- Barra de respuesta -->
            <div id="reply-preview-bar">
                <div style="overflow:hidden;">
                    <span style="color:var(--accent); font-weight:bold; font-size:0.8rem;">Respondiendo a:</span>
                    <div id="reply-text-content" style="color:#ccc; font-style:italic; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:0.85rem;">...</div>
                </div>
                <i class="fas fa-times" id="closeReplyBtn" style="cursor:pointer; color:#888; padding:5px;"></i>
            </div>

            <!-- Input -->
            <div style="padding:15px; background:#1a1a20;">
                <div class="input-bar">
                    <input type="file" id="imageInput" accept="image/*, application/pdf" style="display:none;">
                    <button id="btnUpload" class="action-btn" title="Adjuntar"><i class="fas fa-paperclip"></i></button>
                    <textarea id="mensajeInput" placeholder="Escribe un mensaje..."></textarea>
                    <button id="enviarMensaje" class="action-btn" style="color:var(--accent);"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- L√ìGICA LOCAL -->
<script>
    // 1. Frases y Poemas
    const FRASES = {
        feliz: ["Tu sonrisa ilumina mi oscuridad.", "Me encanta verte brillar.", "Guarda este momento en tu coraz√≥n."],
        triste: ["Estoy aqu√≠, sosteniendo tu mano.", "Esto tambi√©n pasar√°, mi amor.", "Eres m√°s fuerte de lo que crees."],
        estresada: ["Respira. Inhala, exhala.", "T√≥mate un descanso, el mundo espera.", "Imagina que te abrazo."],
        cansada: ["Descansa, guerrera.", "Deja que el sue√±o repare tus alas.", "Buenas noches, mi vida."],
        extra√±andote: ["Yo te extra√±o m√°s.", "Mi alma est√° contigo.", "Pronto nos veremos."],
        pensandoEnTi: ["Vives en mi mente 24/7.", "Eres mi pensamiento favorito.", "Yo tambi√©n pensaba en ti."],
        conGanasDeVerte: ["Cuento los segundos.", "Un abrazo tuyo lo cura todo.", "Ya falta menos."],
        conGanasDePensar: ["Mente sucia, coraz√≥n contento üòè", "Me encanta cuando te pones as√≠.", "Tengo las mismas ganas."]
    };
    const POEMAS = [
        "ENTRE N√öMEROS Y LETRAS\n\nEntre n√∫meros y letras\nsurgi√≥ una rosa en una libreta.\nEntre ecuaciones y canciones\nsurgieron nuestros amores.",
        "TOMA MI MANO\n\nToma mi mano,\ny acomp√°√±ame al camino\nde la vida.",
        "AMOR ETERNO\n\nPodr√° nublarse el sol eternamente;\nPodr√° secarse en un instante el mar;\nPero jam√°s en m√≠ podr√° apagarse\nLa llama de tu amor."
    ];

    function mostrarMensaje() {
        const emocion = document.getElementById('emocion').value;
        const lista = FRASES[emocion] || ["Te quiero."];
        const frase = lista[Math.floor(Math.random() * lista.length)];
        const div = document.getElementById('mensaje');
        div.textContent = frase; div.style.display = 'block';
        document.dispatchEvent(new CustomEvent('emocionRegistrada', { detail: emocion }));
    }

    function mostrarPoema() {
        const div = document.getElementById('poema');
        div.textContent = POEMAS[Math.floor(Math.random() * POEMAS.length)];
        div.style.display = 'block';
    }

    // Trigger Secreto
    document.getElementById('palabra-secreta').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('seccion-secreta').style.display = 'block';
    });

    document.getElementById('togglePassword').addEventListener('click', () => {
        const inp = document.getElementById('password');
        inp.type = inp.type === "password" ? "text" : "password";
    });

    // Comentarios P√∫blicos Locales
    document.getElementById('enviarMensajePublico').addEventListener('click', () => {
        const txt = document.getElementById('mensajeInputPublico').value;
        if(txt) {
            const div = document.createElement('div');
            div.className = 'fake-comment nuevo-comentario';
            div.innerHTML = `<div class="fake-meta"><span class="fake-user">Usuario</span> ‚Ä¢ ahora mismo</div><p>${txt}</p>`;
            document.getElementById('lista-comentarios').appendChild(div);
            document.getElementById('mensajeInputPublico').value = '';
        }
    });
</script>

<!-- L√ìGICA FIREBASE Y CHAT -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, get, set, update, onValue, serverTimestamp, remove, query, limitToLast, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAcweOs5qS3v4xbzmkYCFLKxVaSWVsly_M",
        authDomain: "estrellita-chl.firebaseapp.com",
        databaseURL: "https://estrellita-chl-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "estrellita-chl",
        storageBucket: "estrellita-chl.firebasestorage.app",
        messagingSenderId: "1006618062076",
        appId: "1:1006618062076:web:8cc3a6bb3ebe800d11fb79",
        measurementId: "G-X2K8ZCR608"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const USUARIO_ESTRELLITA = "oras5982";
    const USUARIO_ADMIN = "jahaziel.alvarezreyes";

    // Lista ampliada de emojis para reaccionar
    const EMOJIS = ["‚ù§Ô∏è","üî•","üòÇ","üòç","üòÆ","üò¢","üò°","üëè","ü•∞","üíú","üòò","ü§©","üíÄ","ü•∫","‚ú®","üòè","ü´∂","üôà","üíã","üéâ"];

    // Emojis R√ÅPIDOS (los que aparecen en la burbuja compacta)
    const EMOJIS_RAPIDOS = ["‚ù§Ô∏è","üòÇ","üòÆ","üî•","ü•∫","üòç","üëè"];

    // Emojis COMPLETOS para el panel (por categor√≠as)
    const EMOJIS_TODOS = [
        // Caras y emociones
        "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","ü§£","üòÇ","üôÇ","üôÉ","üòâ","üòä","üòá","ü•∞","üòç","ü§©","üòò","üòó","üòö","üòô",
        "üòã","üòõ","üòú","ü§™","üòù","ü§ë","ü§ó","ü§≠","ü§´","ü§î","ü§ê","ü§®","üòê","üòë","üò∂","üòè","üòí","üôÑ","üò¨","ü§•",
        "üòî","üò™","ü§§","üò¥","üò∑","ü§í","ü§ï","ü§¢","ü§ß","ü•µ","ü•∂","ü•¥","üòµ","ü§Ø","ü§†","ü•≥","üòé","ü§ì","üßê",
        "üòï","üòü","üôÅ","‚òπÔ∏è","üòÆ","üòØ","üò≤","üò≥","ü•∫","üò¶","üòß","üò®","üò∞","üò•","üò¢","üò≠","üò±","üòñ","üò£",
        "üòû","üòì","üò©","üò´","ü•±","üò§","üò†","üò°","ü§¨","üòà","üëø","üíÄ","‚ò†Ô∏è","üí©","ü§°","üëπ","üë∫","üëª","üëΩ","ü§ñ",
        // Gestos y manos
        "üëã","ü§ö","üñêÔ∏è","‚úã","üññ","üëå","ü§å","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëà","üëâ","üëÜ","üñï","üëá","‚òùÔ∏è","üëç","üëé",
        "‚úä","üëä","ü§õ","ü§ú","üëè","üôå","üëê","ü§≤","ü§ù","üôè","‚úçÔ∏è","üíÖ","ü§≥","üí™","ü¶æ","ü´∂","ü´µ",
        // Corazones y s√≠mbolos
        "‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","‚ù£Ô∏è","üíï","üíû","üíì","üíó","üíñ","üíò","üíù","üíü","‚òÆÔ∏è",
        "‚ú®","üåü","‚≠ê","üí´","üî•","üí•","üéâ","üéä","üéà","üéÅ","üèÜ","ü•á","üéØ","üéÆ","üéµ","üé∂","üé∏","üé§","üé¨","üé≠",
        // Naturaleza y animales
        "üå∏","üå∫","üåª","üåπ","üå∑","üåº","üíê","üåø","üçÄ","üå±","üå≤","üå≥","üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº",
        "üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ","üôà","üôâ","üôä","üêî","üêß","üê¶","ü¶Ü","ü¶Ö","ü¶â","ü¶á","üê∫","üêó",
        // Comida
        "üçé","üçä","üçã","üçá","üçì","üçí","üçë","ü•ù","üçâ","üçå","ü•ë","üçï","üçî","üåÆ","üåØ","üçú","üç£","üç∞","üéÇ","üç©",
        "‚òï","üçµ","üßã","ü•§","üç∫","üçª","ü•Ç","üç∑","ü•É","üçæ","üßÅ","üç´","üç¨","üç≠","üçÆ","üçØ",
        // Objetos y misc
        "üíé","üíç","üëë","üéÄ","üéóÔ∏è","üéüÔ∏è","üé´","üîÆ","ü™Ñ","üßø","üé±","üîë","üóùÔ∏è","üîê","üîí","üí°","üî¶","üïØÔ∏è","ü™î",
        "üì±","üíª","‚å®Ô∏è","üñ•Ô∏è","üñ®Ô∏è","üñ±Ô∏è","üíæ","üíø","üì∑","üì∏","üìπ","üé•","üìû","‚òéÔ∏è","üì†","üì∫","üìª","üéôÔ∏è","üéöÔ∏è","üéõÔ∏è",
        "‚åö","‚è∞","‚åõ","‚è≥","üóìÔ∏è","üìÖ","üìÜ","üóëÔ∏è","üìå","üìç","‚úÇÔ∏è","üñäÔ∏è","‚úèÔ∏è","üñãÔ∏è","üìù","üìñ","üìö","üì∞","üóûÔ∏è"
    ];

    // Inicializar EmailJS
    (function(){ if(window.emailjs) emailjs.init("8SKjsqXHTpjoSMWRw"); })();

    function enviarNotificacionEmail() {
        if(!window.emailjs) return;
        const params = { message: 'Inicio de sesi√≥n detectado', to_email: 'emailjsoras@gmail.com', date: new Date().toLocaleString() };
        emailjs.send('service_poil498', 'template_wyew1g2', params).catch(err => console.error("Error email", err));
    }

    const dom = {
        login: document.getElementById('login'),
        logout: document.getElementById('logout'),
        email: document.getElementById('email'),
        pass: document.getElementById('password'),
        loginBox: document.getElementById('loginContainer'),
        appBox: document.getElementById('contenido-secreto'),
        chat: document.getElementById('chat'),
        input: document.getElementById('mensajeInput'),
        send: document.getElementById('enviarMensaje'),
        replyBar: document.getElementById('reply-preview-bar'),
        replyContent: document.getElementById('reply-text-content'),
        closeReply: document.getElementById('closeReplyBtn'),
        fileBtn: document.getElementById('btnUpload'),
        fileInp: document.getElementById('imageInput'),
        error: document.getElementById('loginError'),
        borrarBtn: document.getElementById('borrarChatBtn')
    };

    let currentUser = null;
    let mensajesVistos = new Set();
    let mensajeRespondiendoA = null;
    let sesionGuardada = false;

    // ---- REGISTRO TIEMPO ----
    function registrarEntrada(nombreUsuario) {
        if (!sessionStorage.getItem('inicioSesion')) {
            const ahora = Date.now();
            sessionStorage.setItem('inicioSesion', ahora);
            sessionStorage.setItem('usuarioSesion', nombreUsuario);
            push(ref(db, 'accesos'), { usuario: nombreUsuario, fecha: new Date().toLocaleString(), timestamp: serverTimestamp() });
        }
    }

    function registrarSalida() {
        const inicio = sessionStorage.getItem('inicioSesion');
        const usuario = sessionStorage.getItem('usuarioSesion');
        if (inicio && usuario && !sesionGuardada) {
            const fin = Date.now();
            const duracionMs = fin - parseInt(inicio);
            const minutos = (duracionMs / 1000 / 60).toFixed(2);
            if (duracionMs > 5000) {
                push(ref(db, 'tiempoSesiones'), {
                    usuario: usuario,
                    inicio: new Date(parseInt(inicio)).toLocaleString(),
                    fin: new Date(fin).toLocaleString(),
                    duracionMinutos: minutos + " min",
                    timestamp: serverTimestamp()
                });
                console.log("Sesi√≥n finalizada y guardada:", minutos, "minutos");
            }
            sesionGuardada = true;
            sessionStorage.removeItem('inicioSesion');
        }
    }

    window.addEventListener('pagehide', registrarSalida);

    // ---- AUTH ----
    dom.login.addEventListener('click', () => {
        dom.error.textContent = "";
        enviarNotificacionEmail();
        signInWithEmailAndPassword(auth, dom.email.value, dom.pass.value).catch(err => {
            console.error(err);
            dom.error.textContent = "Error: Verifica tus datos.";
        });
    });

    dom.logout.addEventListener('click', () => {
        registrarSalida();
        signOut(auth).then(() => { sessionStorage.clear(); location.reload(); });
    });

    onAuthStateChanged(auth, (user) => {
        if(user) {
            currentUser = user;
            const short = user.email.split('@')[0];
            const name = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
            document.getElementById('nombre-usuario').textContent = name;
            
            sesionGuardada = false;
            registrarEntrada(name);
            dom.loginBox.style.display = 'none';
            dom.appBox.classList.remove('hidden');
            iniciarChat();

            if(short === USUARIO_ADMIN) {
                document.getElementById('admin-info').classList.remove('hidden');
                dom.borrarBtn.classList.remove('hidden');
                iniciarContadores();
                dom.borrarBtn.onclick = () => {
                    if(confirm("¬øEst√°s segura de borrar TODO el chat? No hay vuelta atr√°s.")) {
                        remove(ref(db, 'mensajes'));
                    }
                };
            }

            document.addEventListener('emocionRegistrada', (e) => {
                if(short === USUARIO_ESTRELLITA) {
                    const emo = e.detail;
                    const cRef = ref(db, `contadores/${emo}`);
                    get(cRef).then(s => set(cRef, (s.val()||0)+1));
                    push(ref(db, 'historialEmociones'), {
                        emocion: emo, usuario: name, timestamp: serverTimestamp(), fecha: new Date().toLocaleString()
                    });
                }
            });

        } else {
            dom.loginBox.style.display = 'flex';
            dom.appBox.classList.add('hidden');
        }
    });

    // ---- CHAT ----
    function iniciarChat() {
        const chatRef = ref(db, 'mensajes');
        dom.chat.innerHTML = '';
        mensajesVistos.clear();

        const q = query(chatRef, orderByChild('timestamp'), limitToLast(50));
        onChildAdded(q, (snap) => {
            if(mensajesVistos.has(snap.key)) return;
            mensajesVistos.add(snap.key);
            renderMsg(snap.val(), snap.key);
        });

        // Solo actualizamos el badge de reacci√≥n, sin destruir el elemento ni sus listeners
        onChildChanged(q, (snap) => {
            const data = snap.val();
            const key = snap.key;
            const row = document.getElementById(`msg-${key}`);
            if (!row) return;

            // Actualizar badge de reacci√≥n
            let badge = row.querySelector('.reaction-badge');
            if (data.reaction) {
                if (badge) {
                    badge.textContent = data.reaction;
                } else {
                    const bubble = row.querySelector('.bubble');
                    if (bubble) {
                        badge = document.createElement('div');
                        badge.className = 'reaction-badge';
                        badge.textContent = data.reaction;
                        bubble.appendChild(badge);
                    }
                }
            } else {
                if (badge) badge.remove();
            }
        });

        onValue(chatRef, (snap) => {
            if(!snap.exists()) { dom.chat.innerHTML = ''; mensajesVistos.clear(); }
        });
    }

    function createMessageHTML(data, key) {
        if(!currentUser) return '';
        const short = currentUser.email.split('@')[0];
        const miNombre = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
        const esMio = data.usuario === miNombre;
        
        let content = '';
        if(data.tipo === 'imagen') content = `<img src="${data.mensaje}" style="max-width:100%; border-radius:8px; margin-top:4px;">`;
        else if(data.tipo === 'pdf') content = `<div class="pdf-attachment"><i class="fas fa-file-pdf"></i> <a href="${data.mensaje}" download="${data.nombreArchivo}" style="color:white; text-decoration:none;">${data.nombreArchivo}</a></div>`;
        else content = data.mensaje.replace(/\n/g, '<br>');

        let replyHTML = '';
        if (data.replyTo) {
            const replyColor = esMio ? '#ffcc00' : 'var(--accent)';
            replyHTML = `<div class="reply-context"><span class="reply-user" style="color:${replyColor}">${data.replyTo.user}</span><span class="reply-text">${data.replyTo.text}</span></div>`;
        }

        let badgeHTML = data.reaction ? `<div class="reaction-badge">${data.reaction}</div>` : '';

        // Men√∫ r√°pido: emojis predefinidos + bot√≥n "+"
        const emojisRapidosHTML = EMOJIS_RAPIDOS.map(e => `<span class="emoji-opt" onclick="window._chatAct('react','${key}','${e}')">${e}</span>`).join('');
        const botonMas = `<button class="emoji-more-btn" onclick="window._abrirPanelEmojis('${key}')">+</button>`;
        const menuHTML = `<div id="menu-${key}" class="reaction-menu">${emojisRapidosHTML}${botonMas}</div>`;

        // Bot√≥n responder (desktop hover)
        let safeText = data.tipo === 'texto' ? data.mensaje.replace(/"/g, '&quot;').replace(/'/g, "\\'").replace(/\n/g, ' ') : 'üìé Archivo';
        const replyBtn = `<div class="reply-action-btn" onclick="window._chatAct('reply','${key}','${data.usuario}','${safeText}')"><i class="fas fa-reply"></i></div>`;

        const nameTag = esMio ? '' : `<span class="msg-name">${data.usuario}</span>`;

        return `
            <div id="msg-${key}" class="msg-row ${esMio ? 'me' : 'other'}" data-key="${key}" data-user="${data.usuario}" data-text="${safeText}">
                <div class="msg-content-wrapper">
                    ${esMio ? replyBtn : ''}
                    <div class="bubble" data-key="${key}">
                        ${menuHTML}
                        ${nameTag}
                        ${replyHTML}
                        ${content}
                        ${badgeHTML}
                    </div>
                    ${!esMio ? replyBtn : ''}
                </div>
                <span class="swipe-reply-indicator"><i class="fas fa-reply"></i></span>
            </div>`;
    }

    function renderMsg(data, key) {
        dom.chat.insertAdjacentHTML('beforeend', createMessageHTML(data, key));
        attachMobileGestures(document.getElementById(`msg-${key}`), key, data);
        requestAnimationFrame(() => dom.chat.scrollTop = dom.chat.scrollHeight);
    }

    // ---- ACCIONES GLOBALES ----
    window._chatAct = function(action, id, p1, p2) {
        if (action === 'react') {
            update(ref(db, `mensajes/${id}`), { reaction: p1 });
            // Cerrar todos los men√∫s
            document.querySelectorAll('.reaction-menu.active').forEach(el => el.classList.remove('active'));
            const cm = document.getElementById('custom-context-menu');
            if(cm) { cm.classList.remove('active'); cm.style.display='none'; }
            cerrarPanelEmojis();
        }
        else if (action === 'reply') {
            mensajeRespondiendoA = { id: id, user: p1, text: p2 };
            dom.replyBar.style.display = 'flex';
            const preview = p2.length > 40 ? p2.substring(0,40)+'...' : p2;
            dom.replyContent.textContent = `${p1}: ${preview}`;
            dom.input.focus();
        }
    };

    // ---- PANEL COMPLETO DE EMOJIS ----
    let panelKeyActivo = null;

    window._abrirPanelEmojis = function(key) {
        // Cerrar men√∫s compactos
        document.querySelectorAll('.reaction-menu.active').forEach(el => el.classList.remove('active'));
        const cm = document.getElementById('custom-context-menu');
        if(cm) { cm.classList.remove('active'); cm.style.display='none'; }

        panelKeyActivo = key;
        const grid = document.getElementById('emoji-full-grid');
        const panel = document.getElementById('emoji-full-panel');
        const overlay = document.getElementById('emoji-panel-overlay');

        // Rellenar el grid solo si est√° vac√≠o (optimizaci√≥n)
        if (!grid.hasChildNodes()) {
            grid.innerHTML = EMOJIS_TODOS.map(em =>
                `<span class="emoji-full-opt" onclick="window._reaccionarDesdePanel('${em}')">${em}</span>`
            ).join('');
        }

        overlay.classList.add('active');
        panel.classList.add('active');
    };

    window._reaccionarDesdePanel = function(emoji) {
        if (panelKeyActivo) {
            window._chatAct('react', panelKeyActivo, emoji);
        }
    };

    function cerrarPanelEmojis() {
        document.getElementById('emoji-full-panel').classList.remove('active');
        document.getElementById('emoji-panel-overlay').classList.remove('active');
        panelKeyActivo = null;
    }

    document.getElementById('emoji-full-panel-close').addEventListener('click', cerrarPanelEmojis);
    document.getElementById('emoji-panel-overlay').addEventListener('click', cerrarPanelEmojis);

    // ---- DESKTOP: CLIC DERECHO (delegado a document para m√°xima fiabilidad) ----
    document.addEventListener('contextmenu', (e) => {
        // Buscar la burbuja m√°s cercana al elemento clickeado
        const bubble = e.target.closest('.bubble');

        // Si el clic derecho no es sobre una burbuja, permitir men√∫ normal del navegador
        if (!bubble) return;

        // Bloquear el men√∫ nativo del navegador
        e.preventDefault();
        e.stopPropagation();

        const key = bubble.dataset.key;
        if (!key) return;

        const cm = document.getElementById('custom-context-menu');

        // Reconstruir el men√∫ con los emojis r√°pidos + bot√≥n + y el key correcto
        cm.innerHTML = EMOJIS_RAPIDOS.map(em => `<span class="emoji-opt" onclick="window._chatAct('react','${key}','${em}')">${em}</span>`).join('') +
            `<button class="emoji-more-btn" onclick="window._abrirPanelEmojis('${key}')">+</button>`;

        // Mostrar el men√∫
        cm.style.display = 'flex';
        cm.classList.add('active');

        // Calcular posici√≥n para que no se salga de pantalla
        const menuWidth = EMOJIS.length * 38 + 20; // estimado
        let x = e.clientX;
        let y = e.clientY - 60;
        if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 10;
        if (y < 10) y = e.clientY + 10;

        cm.style.left = x + 'px';
        cm.style.top = y + 'px';

        // Cerrar al hacer clic en cualquier sitio (excepto el propio men√∫)
        const closeCM = (ev) => {
            if (!cm.contains(ev.target)) {
                cm.style.display = 'none';
                cm.classList.remove('active');
                document.removeEventListener('mousedown', closeCM);
                document.removeEventListener('contextmenu', closeCMOnContext);
            }
        };
        const closeCMOnContext = () => {
            cm.style.display = 'none';
            cm.classList.remove('active');
            document.removeEventListener('mousedown', closeCM);
            document.removeEventListener('contextmenu', closeCMOnContext);
        };
        // Usamos setTimeout para no capturar el mismo evento
        setTimeout(() => {
            document.addEventListener('mousedown', closeCM);
            document.addEventListener('contextmenu', closeCMOnContext);
        }, 0);
    });

    // ---- MOBILE: LONG PRESS + SWIPE ----
    function attachMobileGestures(row, key, data) {
        if (!row) return;
        const bubble = row.querySelector('.bubble');
        const wrapper = row.querySelector('.msg-content-wrapper');
        const indicator = row.querySelector('.swipe-reply-indicator');

        let pressTimer = null;
        let startX = 0;
        let startY = 0;
        let moved = false;
        let swipeActivated = false;
        let longPressTriggered = false;

        // ---- LONG PRESS (passive:false para poder hacer preventDefault) ----
        bubble.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            moved = false;
            swipeActivated = false;
            longPressTriggered = false;

            pressTimer = setTimeout(() => {
                if (!moved) {
                    longPressTriggered = true;
                    e.preventDefault(); // Evita selecci√≥n de texto del navegador
                    if (navigator.vibrate) navigator.vibrate(60);
                    showMobileEmojiMenu(key);
                }
            }, 550);
        }, { passive: false }); // CLAVE: passive:false permite preventDefault

        bubble.addEventListener('touchmove', (e) => {
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            const totalMove = Math.sqrt(dx * dx + dy * dy);

            // Si se mueve m√°s de 10px en cualquier direcci√≥n, cancelar long press
            if (totalMove > 10) {
                moved = true;
                clearTimeout(pressTimer);
            }

            // L√≥gica de swipe horizontal
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 8) {
                const clampedDx = Math.max(0, Math.min(dx, 75));
                wrapper.style.transform = `translateX(${clampedDx * 0.55}px)`;
                if (indicator) indicator.style.opacity = Math.min(clampedDx / 55, 1);
                if (clampedDx > 55 && !swipeActivated) {
                    swipeActivated = true;
                }
            }
        }, { passive: true });

        bubble.addEventListener('touchend', (e) => {
            clearTimeout(pressTimer);

            // Restaurar posici√≥n con transici√≥n suave
            wrapper.style.transition = 'transform 0.25s ease';
            wrapper.style.transform = '';
            if (indicator) indicator.style.opacity = 0;
            setTimeout(() => { wrapper.style.transition = ''; }, 260);

            if (swipeActivated && !longPressTriggered) {
                const safeText = data.tipo === 'texto'
                    ? data.mensaje.replace(/"/g, '&quot;').replace(/'/g, "\\'").replace(/\n/g, ' ')
                    : 'üìé Archivo';
                window._chatAct('reply', key, data.usuario, safeText);
            }
        }, { passive: true });

        // Cancelar si el dedo se levanta r√°pido
        bubble.addEventListener('touchcancel', () => {
            clearTimeout(pressTimer);
            wrapper.style.transform = '';
            if (indicator) indicator.style.opacity = 0;
        }, { passive: true });
    }

    function showMobileEmojiMenu(key) {
        // Cerrar cualquier men√∫ previo
        document.querySelectorAll('.reaction-menu.active').forEach(el => el.classList.remove('active'));

        const menu = document.getElementById(`menu-${key}`);
        if (!menu) return;

        menu.classList.add('active');

        // Cerrar al tocar fuera (con un peque√±o delay para no capturar el mismo touchend)
        setTimeout(() => {
            const closeMenu = (ev) => {
                if (!menu.contains(ev.target)) {
                    menu.classList.remove('active');
                    document.removeEventListener('touchstart', closeMenu);
                }
            };
            document.addEventListener('touchstart', closeMenu, { passive: true });
        }, 200);
    }

    // ---- REPLY BAR ----
    dom.closeReply.addEventListener('click', () => {
        mensajeRespondiendoA = null;
        dom.replyBar.style.display = 'none';
    });

    // ---- ENVIAR ----
    dom.send.addEventListener('click', enviarTexto);
    dom.input.addEventListener('keypress', (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); enviarTexto(); } });

    function enviarTexto() {
        const txt = dom.input.value.trim();
        if(!txt) return;
        const short = currentUser.email.split('@')[0];
        const name = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
        
        const payload = { usuario: name, mensaje: txt, tipo: 'texto', timestamp: serverTimestamp() };
        if (mensajeRespondiendoA) {
            payload.replyTo = { user: mensajeRespondiendoA.user, text: mensajeRespondiendoA.text };
            mensajeRespondiendoA = null;
            dom.replyBar.style.display = 'none';
        }
        push(ref(db, 'mensajes'), payload);
        dom.input.value = '';
    }

    // ---- ARCHIVOS ----
    dom.fileBtn.addEventListener('click', () => dom.fileInp.click());
    dom.fileInp.addEventListener('change', function(e) {
        const f = e.target.files[0];
        if(!f) return;
        const isPdf = f.type === 'application/pdf';
        if(f.size > (isPdf?0.5:5)*1024*1024) { alert("Archivo muy grande"); return; }
        
        const short = currentUser.email.split('@')[0];
        const name = short === USUARIO_ESTRELLITA ? "Estrellita" : (short === USUARIO_ADMIN ? "Luna" : "Usuario");
        const r = new FileReader();

        if(f.type.startsWith('image/')) {
            r.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d');
                    const scale = 500/img.width;
                    c.width = 500; c.height = img.height*scale;
                    ctx.drawImage(img,0,0,c.width,c.height);
                    push(ref(db, 'mensajes'), { usuario: name, mensaje: c.toDataURL('image/jpeg',0.7), tipo: 'imagen', timestamp: serverTimestamp() });
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        } else if(isPdf) {
            r.onload = (ev) => push(ref(db, 'mensajes'), { usuario: name, mensaje: ev.target.result, tipo: 'pdf', nombreArchivo: f.name, timestamp: serverTimestamp() });
            r.readAsDataURL(f);
        }
        this.value = '';
    });

    // ---- ADMIN ----
    function iniciarContadores() {
        onValue(ref(db, 'contadores'), (snap) => {
            const d = snap.val();
            const div = document.getElementById('contadores-container');
            if(!d) { div.innerHTML = "Sin datos."; return; }
            div.innerHTML = '';
            Object.entries(d).forEach(([k,v]) => {
                div.innerHTML += `<span class="stat-tag">${k}: <strong style="color:var(--gold)">${v}</strong></span>`;
            });
        });
    }
</script>
</body>
</html>
